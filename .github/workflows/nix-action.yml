# This file was generated from `meta.yml`, please do not edit manually.
# Follow the instructions on https://github.com/coq-community/templates to regenerate.
name: Nix CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - '**'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
    - name: Do nothing
      run: echo "No setup, using meta.yml tasks"

  "_deps":
    runs-on: ubuntu-latest
    needs:
      - setup
    strategy:
      matrix:
        task:
          - "coq-8.13"
          - "coq-8.12"
          - "coq-8.11+multinomials"
    steps:
    - name: Cachix install
      uses: cachix/install-nix-action@v12
      with:
        nix_path: nixpkgs=channel:nixpkgs-unstable
    - name: Cachix setup coq
      uses: cachix/cachix-action@v8
      with:
        # Name of a cachix cache to pull/substitute
        name: coq
    - name: Cachix setup math-comp
      uses: cachix/cachix-action@v8
      with:
        # Name of a cachix cache to pull/substitute
        name: math-comp
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: Git checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Building/fetching current CI target
      run: nix-build --no-out-link --argstr task "${{ matrix.task }}" --argstr job "_deps"

  "mathcomp-analysis":
    runs-on: ubuntu-latest
    needs:
      - setup
      - "_deps"
    strategy:
      matrix:
        task:
          - "coq-8.13"
          - "coq-8.12"
          - "coq-8.11+multinomials"
    steps:
    - name: Cachix install
      uses: cachix/install-nix-action@v12
      with:
        nix_path: nixpkgs=channel:nixpkgs-unstable
    - name: Cachix setup coq
      uses: cachix/cachix-action@v8
      with:
        # Name of a cachix cache to pull/substitute
        name: coq
    - name: Cachix setup math-comp
      uses: cachix/cachix-action@v8
      with:
        # Name of a cachix cache to pull/substitute
        name: math-comp
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: Git checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Building/fetching previous target _deps
      run: nix-build --no-out-link --argstr task "${{ matrix.task }}" --argstr job "_deps"
    - name: Building/fetching current CI target
      run: nix-build --no-out-link --argstr task "${{ matrix.task }}" --argstr job "mathcomp-analysis"

  "_allJobs":
    runs-on: ubuntu-latest
    needs:
      - setup
      - "_deps"
      - "mathcomp-analysis"
    strategy:
      matrix:
        task:
          - "coq-8.13"
          - "coq-8.12"
          - "coq-8.11+multinomials"
    steps:
    - name: Cachix install
      uses: cachix/install-nix-action@v12
      with:
        nix_path: nixpkgs=channel:nixpkgs-unstable
    - name: Cachix setup coq
      uses: cachix/cachix-action@v8
      with:
        # Name of a cachix cache to pull/substitute
        name: coq
    - name: Cachix setup math-comp
      uses: cachix/cachix-action@v8
      with:
        # Name of a cachix cache to pull/substitute
        name: math-comp
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: Git checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Building/fetching previous target _deps
      run: nix-build --no-out-link --argstr task "${{ matrix.task }}" --argstr job "_deps"
    - name: Building/fetching previous target mathcomp-analysis
      run: nix-build --no-out-link --argstr task "${{ matrix.task }}" --argstr job "mathcomp-analysis"
    - name: Building/fetching current CI target
      run: nix-build --no-out-link --argstr task "${{ matrix.task }}" --argstr job "_allJobs"
